{% extends "index.html" %}
{% block title %}{{ "consultar" }}{% endblock %}

{% block content %}
<div class="container mt-1 p-3" >
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xl-6 d-flex justify-content-center ">
            <img width="125px" height="125px" src="/static/img/Logo_Vertical_IDEXUD_Final-1-3-1.png" alt="logo oficina de extensión" >
        </div>
    </div>
    <div class="row justify-content-center  ">
      <div class="col-lg-6 text-center"  >
        <h1 style="color: #F0821A; text-align-last: center;"> Módulo de consulta de contratos</h1> 
        <p> 
          Busca fácilmente tus contratos de la unidad de extension de la universidad Distrital Francisco jose de Caldas.</p>
        </div>
      </div>
    </div>
<div class="row m-5 justify-content-center">
    <div class="col-lg-6 col-md-6 col-sm-6 col-xl-6 bg-body-tertiary border border-secondary rounded p-4" >
        <div class="text-center">
            <h3>Bienvenido al módulo de generación de certificados</h3>
        </div>
        <div>
            <p>Por favor, ingrese sus datos para consultar los certificados asociados a su nombre, cédula, telefono, correo y dirección
                proporcionado en su contrato laboral.</p>
        </div>
        <form action="#" method="get">
            {% csrf_token %}
            <div class="mb-3 row">
                <label for="Name" class="col-sm-4 col-form-label">Nombre completo*</label>
                <input type="text" class="form-control" id="Nameconsultor" placeholder="Nombre y apellido" required>
            </div>
            <div class="mb-3 row">
                <label for="Cedula" class="col-sm-2 col-form-label">Cédula*</label>
                <input type="text" pattern="^\d{6,11}$" class="form-control" id="Cedula" placeholder="123456789"
                    required>
            </div>
            <div class="mb-3 row">
                <label for="correo" class="col-sm-2 col-form-label">Correo*</label>
                <input type="text" pattern="[a-zA-Z0-9_]+([.][a-zA-Z0-9_]+)*@[a-zA-Z0-9_]+([.][a-zA-Z0-9_]+)*[.][a-zA-Z]{2,5}" title="Debe ser del formato nombre@correo.com" class="form-control" id="correo" placeholder="nombre@correo.com"
                    required>
            </div>
            <div class="mb-3 row">
                <label for="telefono" class="col-sm-2 col-form-label">Teléfono*</label>
                <input type="text" pattern="[\(]?[\+]?(\d{2}|\d{3})[\)]?[\s]?(\d{6}|\d{8}|\d{10}|\d{12}|\d{3}[\*\.\-]{2}\d{3}|\d{2}[\*\.\-\s]{3}\d{2}|\d{4}[\*\.\-\s]\d{4})" class="form-control" id="telefono" title="Deben ser del formato  3112223334 o +57 3112223334" placeholder="3112223334"
                    required>
            </div>
            <div class="mb-3 row">
                <label for="direccion" class="col-sm-4 col-form-label d-flex">Dirección&nbsp;<p style="font-size: smaller; color: gray; padding-top: 2px;"> (Opcional)</p></label>
                <input type="text" class="form-control" id="direccion" title="kra 1 # 1-1" placeholder="kra 1 # 1-1"
                    >
            </div>

            <div class="row justify-content-end">
                <input type="button" id="btnBuscar" class=" ml-4 form-control btn btn-primary justify-content-end "
                    style="max-width: 150px;" value="buscar" onclick="buscar()">
            </div>

        </form>
    </div>
    <div class="col-lg-8 mt-5 ">
        <h4>Resultados</h4>
        <div class="col-lg-5 ">
            <input type="text" class="form-control"style=" border-color: #919191 ;" id="filtroInput" placeholder="Filtro">

        </div>
        <div>
            <table class="table table-striped table-bordered mt-4 border border-dark" id="tableuser">
                <thead class="">
                    <tr>
                        <th>Contratos encontrados</th>
                        <th style="width: 1px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="display: none;">
                        <td>
                        </td>
                        <td >
                            <button class="btn btn-outline-secondary btn-sm" type="button"><ion-icon
                                    name="download-outline" class="ico"></ion-icon></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.getElementById('filtroInput').addEventListener('input', function () {
        filtrarTabla();
    });

    function filtrarTabla() {
        var input, filtro, tabla, filas, celdas, textoValor;
        input = document.getElementById('filtroInput');
        filtro = input.value.toUpperCase();
        tabla = document.getElementById('tableuser');
        filas = tabla.getElementsByTagName('tr');

        for (var i = 0; i < filas.length; i++) {
            celdas = filas[i].getElementsByTagName('td');
            for (var j = 0; j < celdas.length; j++) {
                textoValor = celdas[j].textContent || celdas[j].innerText;
                if (textoValor.toUpperCase().indexOf(filtro) > -1) {
                    filas[i].style.display = '';
                    break;
                } else {
                    filas[i].style.display = 'none';
                }
            }
        }
    }
</script>

<script>
    // ...

    function habilitarBoton() {
        var nombre = document.getElementById('Nameconsultor').value.trim();
        var cedula = document.getElementById('Cedula').value.trim();
        var correo = document.getElementById('correo').value.trim();
        var telefono = document.getElementById('telefono').value.trim();
        var direccion = document.getElementById('direccion').value.trim();
        var botonBuscar = document.getElementById('btnBuscar');

        botonBuscar.disabled = !(nombre && cedula && correo && telefono);
    }

    function buscar() {
        var nombreCons = document.getElementById('Nameconsultor').value.trim();
        var cedulaCons = document.getElementById('Cedula').value.trim();
        var correoCons = document.getElementById('correo').value.trim();
        var telefonoCons = document.getElementById('telefono').value.trim();
        var direccionCons = document.getElementById('direccion').value.trim();

        // Validar que ambos campos estén diligenciados
        if (!nombreCons || !cedulaCons || !correoCons || !telefonoCons) {
            alert("Por favor, diligencie el campo de nombre, cédula, correo y telefono.");
            return;
        }

        let urlPatch = "{% url 'api:contrato_api' %}";
        let csrftoken = $('[name=csrfmiddlewaretoken]').val();

        $.ajax({
            url: urlPatch,
            type: 'get',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (response) {
                const cedulasEnApi = response.map(x => x.cedula.toLowerCase().trim());
                const correoEnApi = response.map(x => x.correo.toLowerCase().trim());

                // Validar que la cédula ingresada esté exactamente en la lista de cédulas de la API
                if (!cedulasEnApi.includes(cedulaCons.toLowerCase())) {
                    alert(`La cédula ${cedulaCons} ingresada no coincide con ninguna registrada.`);
                    return;
                }
                if (!correoEnApi.includes(correoCons.toLowerCase())) {
                    alert(`El correo ${correoCons} ingresado no coincide con ninguna registrada.`);
                    return;
                }

                const busquedaDataNotificacion = response.filter((x) => {
                    return (
                        (nombreCons ? x.nombreConsultor?.toLowerCase()?.includes(nombreCons.toLowerCase()) : true) &&
                        (cedulaCons ? x?.cedula?.toLowerCase()?.includes(cedulaCons.toLowerCase()) : true)&&
                        (correoCons ? x?.correo?.toLowerCase()?.includes(correoCons.toLowerCase()) : true) &&
                        (telefonoCons ? x?.telefono?.toLowerCase()?.includes(telefonoCons.toLowerCase()) : true) &&
                        (direccionCons ? x?.direccion?.toLowerCase()?.includes(direccionCons.toLowerCase()) : true) 
                    );
                });

                // Limpia la tabla antes de agregar nuevos resultados
                var tabla = document.getElementById("tableuser").getElementsByTagName('tbody')[0];
                tabla.innerHTML = "";

                // Itera sobre los resultados y agrega filas solo si coinciden nombre y cédula
                busquedaDataNotificacion.forEach(function (elemento) {
                    var fila = tabla.insertRow();
                    var celda = fila.insertCell(0);
                    celda.textContent = `${elemento.idContrato} - ${elemento.nombreConsultor} - ${elemento.fechaInicio}`;

                    // Agrega la celda del botón en la misma fila
                    var celdaBoton = fila.insertCell(1);
                    celdaBoton.innerHTML = `
                    <a href="./PDF/${elemento.id}/${elemento.codigo}">
                        <button class="btn btn-outline-success btn-sm" type="button"><ion-icon name="download-outline" class="ico"></ion-icon></button>
                    </a>`;
                });

            },
            error: function (error) {
                console.log(error);
            }
        });
    }
</script>



<script>
    // Deshabilita el botón de búsqueda al cargar la página
    document.getElementById('btnBuscar').disabled = true;

    // Habilita/deshabilita el botón al cambiar los valores de los campos de nombre y cédula
    document.getElementById('Nameconsultor').addEventListener('input', habilitarBoton);
    document.getElementById('Cedula').addEventListener('input', habilitarBoton);
    document.getElementById('correo').addEventListener('input', habilitarBoton);
    document.getElementById('telefono').addEventListener('input', habilitarBoton);
</script>


{% endblock %}