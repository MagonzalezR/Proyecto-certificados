{% extends "index.html" %}
{% load static %}
{% block title %}{{ "consultar" }}{% endblock %}

{% block content %}
<div class="row m-5 justify-content-center  ">
    <img src="{% static 'img/Logo_Vertical_IDEXUD_Final-1-3-1.png' %}" alt="CarloChupapija">
    <div class="col-lg-6 col-md-6 col-sm-6 col-xl-6 bg-body-tertiary border border-secondary rounded p-4">
        <div>
            <h3>Bienvenido al módulo de generación de certificados</h3>
            <p>Por favor, ingrese sus datos para consultar los certificados asociados a su nombre y cédula
                proporcionado en su contrato laboral.</p>
        </div>
        <form action="#" method="get">
            {% csrf_token %}
            <div class="mb-3 row">
                <label for="Name" class="col-sm-2 col-form-label">Nombre</label>
                <input type="text" class="form-control" id="Nameconsultor" placeholder="Nombre y apellido" required>
            </div>
            <div class="mb-3 row">
                <label for="Cedula" class="col-sm-2 col-form-label">Cedula</label>
                <input type="text" pattern="^\d{6,11}$" class="form-control" id="Cedula" placeholder="123456789"
                    required>
            </div>

            <div class="row justify-content-end">
                <input type="button" id="btnBuscar" class=" ml-4 form-control btn btn-primary justify-content-end "
                    style="max-width: 150px;" value="buscar" onclick="buscar()">
            </div>

        </form>
    </div>
    <div class="col-lg-8 mt-5 ">
        <h2>Resultados</h2>
        <div class="col-lg-5 ">
            <input type="text" class="form-control"style=" border-color: #919191 ;" id="filtroInput" placeholder="Filtro">

        </div>
        <div>
            <table class="table table-striped table-bordered mt-4 border border-dark" id="tableuser">
                <thead class="">
                    <tr>
                        <th>Contratos encontrados</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="display: none;">
                        <td>
                        </td>
                        <td style="width: 100px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button"><ion-icon
                                    name="download-outline" class="ico"></ion-icon></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.getElementById('filtroInput').addEventListener('input', function () {
        filtrarTabla();
    });

    function filtrarTabla() {
        var input, filtro, tabla, filas, celdas, textoValor;
        input = document.getElementById('filtroInput');
        filtro = input.value.toUpperCase();
        tabla = document.getElementById('tableuser');
        filas = tabla.getElementsByTagName('tr');

        for (var i = 0; i < filas.length; i++) {
            celdas = filas[i].getElementsByTagName('td');
            for (var j = 0; j < celdas.length; j++) {
                textoValor = celdas[j].textContent || celdas[j].innerText;
                if (textoValor.toUpperCase().indexOf(filtro) > -1) {
                    filas[i].style.display = '';
                    break;
                } else {
                    filas[i].style.display = 'none';
                }
            }
        }
    }
</script>

<script>
    // ...

    function habilitarBoton() {
        var nombre = document.getElementById('Nameconsultor').value.trim();
        var cedula = document.getElementById('Cedula').value.trim();
        var botonBuscar = document.getElementById('btnBuscar');

        botonBuscar.disabled = !(nombre && cedula);
    }

    function buscar() {
        var nombreCons = document.getElementById('Nameconsultor').value.trim();
        var cedulaCons = document.getElementById('Cedula').value.trim();

        // Validar que ambos campos estén diligenciados
        if (!nombreCons || !cedulaCons) {
            alert("Por favor, diligencie tanto el campo de nombre como el de cédula.");
            return;
        }

        let urlPatch = "{% url 'api:contrato_api' %}";
        let csrftoken = $('[name=csrfmiddlewaretoken]').val();
        let username = "admin";  // Replace with your actual username
        let password = "admin";  // Replace with your actual password

        $.ajax({
            url: urlPatch,
            type: 'get',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                xhr.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + password));
            },
            success: function (response) {
                const cedulasEnApi = response.map(x => x.cedula.toLowerCase().trim());

                // Validar que la cédula ingresada esté exactamente en la lista de cédulas de la API
                if (!cedulasEnApi.includes(cedulaCons.toLowerCase())) {
                    alert(`La cédula ${cedulaCons} ingresada no coincide con ninguna registrada.`);
                    return;
                }

                const busquedaDataNotificacion = response.filter((x) => {
                    return (
                        (nombreCons ? x.nombreConsultor?.toLowerCase()?.includes(nombreCons.toLowerCase()) : true) &&
                        (cedulaCons ? x?.cedula?.toLowerCase()?.includes(cedulaCons.toLowerCase()) : true)
                    );
                });

                // Limpia la tabla antes de agregar nuevos resultados
                var tabla = document.getElementById("tableuser").getElementsByTagName('tbody')[0];
                tabla.innerHTML = "";

                // Itera sobre los resultados y agrega filas solo si coinciden nombre y cédula
                busquedaDataNotificacion.forEach(function (elemento) {
                    var fila = tabla.insertRow();
                    var celda = fila.insertCell(0);
                    celda.textContent = `${elemento.idContrato} - ${elemento.nombreConsultor} - ${elemento.fechaInicio}`;

                    // Agrega la celda del botón en la misma fila
                    var celdaBoton = fila.insertCell(1);
                    celdaBoton.innerHTML = `
                    <a href="./PDF/${elemento.id}">
                        <button class="btn btn-outline-secondary btn-sm" type="button"><ion-icon name="download-outline" class="ico"></ion-icon></button>
                    </a>`;
                });

            },
            error: function (error) {
                console.log(error);
            }
        });
    }
</script>



<script>
    // Deshabilita el botón de búsqueda al cargar la página
    document.getElementById('btnBuscar').disabled = true;

    // Habilita/deshabilita el botón al cambiar los valores de los campos de nombre y cédula
    document.getElementById('Nameconsultor').addEventListener('input', habilitarBoton);
    document.getElementById('Cedula').addEventListener('input', habilitarBoton);
</script>


{% endblock %}